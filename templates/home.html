{% extends "base.html" %}

{% block content %}

<div class="header-bar">
    <h1>Budget Tracker</h1>

    <div class="user-menu">
        <svg class="user-icon" viewBox="0 0 24 24">
            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
        </svg>
        <div class="dropdown-content">
            <p>{{ username }}</p>
            <button onclick='switchTheme()' class='btn'>Toggle Theme</button>
            <a href='/logout' class='logout-btn'>Logout</a>
        </div>
    </div>
</div>

{% with messages = get_flashed_messages() %}
  {% if messages %}
    {% for message in messages %}
      <div class="flash-message">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<div class='card' style="text-align: center; padding: 10px;">
    <form method="GET" action="/">
        <label style="font-weight: bold; margin-right: 10px;">Filter:</label>
        
        <select name="year" onchange="this.form.submit()" style="width: auto; display: inline-block;">
            <option value="2024" {% if current_year == '2024' %}selected{% endif %}>2024</option>
            <option value="2025" {% if current_year == '2025' %}selected{% endif %}>2025</option>
            <option value="2026" {% if current_year == '2026' %}selected{% endif %}>2026</option>
        </select>

        <select name="month" onchange="this.form.submit()" style="width: auto; display: inline-block;">
            <option value="01" {% if current_month_num == '01' %}selected{% endif %}>January</option>
            <option value="02" {% if current_month_num == '02' %}selected{% endif %}>February</option>
            <option value="03" {% if current_month_num == '03' %}selected{% endif %}>March</option>
            <option value="04" {% if current_month_num == '04' %}selected{% endif %}>April</option>
            <option value="05" {% if current_month_num == '05' %}selected{% endif %}>May</option>
            <option value="06" {% if current_month_num == '06' %}selected{% endif %}>June</option>
            <option value="07" {% if current_month_num == '07' %}selected{% endif %}>July</option>
            <option value="08" {% if current_month_num == '08' %}selected{% endif %}>August</option>
            <option value="09" {% if current_month_num == '09' %}selected{% endif %}>September</option>
            <option value="10" {% if current_month_num == '10' %}selected{% endif %}>October</option>
            <option value="11" {% if current_month_num == '11' %}selected{% endif %}>November</option>
            <option value="12" {% if current_month_num == '12' %}selected{% endif %}>December</option>
        </select>
    </form>
</div>

<div class='card'>
<h3>Add Transaction</h3>
<form method='POST' action='/add'>
    <input type='date' name='date' value='{{today}}' required>
    <input type='number' name='amount' step='0.01' placeholder='Amount' required>
    
    <select name='category' required>
        <option value="" disabled selected>Select Category</option>
        <option value="Food">Food</option>
        <option value="Transport">Transport</option>
        <option value="Rent">Rent</option>
        <option value="Entertainment">Entertainment</option>
        <option value="Salary">Salary</option>
        <option value="Other">Other</option>
    </select>

    <select name='type'>
        <option value='income'>Income</option>
        <option value='expense'>Expense</option>
    </select>
    <input name='description' placeholder='Description (optional)'>
    <button class='btn'>Add</button>
</form>
</div>

<div class='card'>
<h3>Summary</h3>
<p><b>Total Income:</b> ${{income}}</p>
<p><b>Total Expense:</b> ${{expense}}</p>
<p><b>Net Balance:</b> ${{net}}</p>
</div>

<div class='card'>
    <h3>Expenses by Category</h3>
    <div style="max-width: 400px; margin: 0 auto;">
        <canvas id="expenseChart"></canvas>
    </div>
</div>

<div class='card table-container'>
<h3>Transactions</h3>
<table>
<tr>
    <th>Date</th><th>Amount</th><th>Type</th><th>Category</th><th>Description</th><th></th>
</tr>
{% for row in rows %}
<tr>
    <td>{{row.date}}</td>
    <td>${{row.amount}}</td>
    <td>{{row.type}}</td>
    <td>{{row.category}}</td>
    <td>{{row.description}}</td>
    <td>
        <form method='POST' action='/delete/{{row.id}}' onsubmit="return confirm('Are you sure you want to delete this?');">
            <button class='delete-btn'>&times;</button>
        </form>
    </td>
</tr>
{% endfor %}
</table>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // 1. Get the data passed from Python
    // We use |tojson to make sure Python lists become JavaScript arrays
    const labels = {{ chart_labels | tojson }};
    const data = {{ chart_values | tojson }};

    // 2. Configure the Chart
    const ctx = document.getElementById('expenseChart').getContext('2d');
    
    // Only draw if there is data
    if (labels.length > 0) {
        new Chart(ctx, {
            type: 'doughnut',  // You can change this to 'pie' or 'bar'
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: [
                        '#ff3b30', // Red
                        '#0071e3', // Blue
                        '#34c759', // Green
                        '#ff9500', // Orange
                        '#af52de', // Purple
                        '#5ac8fa', // Light Blue
                        '#ffcc00'  // Yellow
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                    }
                }
            }
        });
    } else {
        // Show a message if no expenses exist yet
        document.getElementById('expenseChart').style.display = 'none';
        document.write("<p style='text-align:center; color:gray;'>No expenses to show yet.</p>");
    }
</script>

{% endblock %} 
